# make an SD suitable for the GTA04
#
# creates a single partition bootable Debian image + kernel + QuantumSTEP (but no boot loader)
# this works on Letux 2804, 3704 and 7004
#
# run this script on a host PC with SD-reader

[ "$ROOTFS" ] || export ROOTFS=http://download.goldelico.com/gta04/quantumstep/latest-quantumstep.tbz

# $DEV should be initialized to some device, e.g. "/dev/sdc"

#
# my eeePC has this configuration:
#
# /dev/sda:	internal flash (debian)
# /dev/sdb:	internal SD reader
# /dev/sdc: external SD reader
# /dev/sdd: external CF reader
# /dev/sde: external ? reader

# create mount point(s)

mkdir -p /media/rootfs

if [ "$DEV" ]
then

umount ${DEV}1

if [ "${DEV}" = "/dev/sda" ]
then
	echo "can't overwrite /dev/sda"
	exit 1
elif [ -b "$DEV" ]
then
	{
		echo ';'	# one big Linux partition
	} | sfdisk --force -D -uM $DEV
	/sbin/partprobe $DEV
	[ -b "${DEV}p1" ] && DEV=${DEV}p
	mke2fs -j -L "rootfs" ${DEV}1
else
	echo "not a block device: $DEV"
	exit 1
fi

umount ${DEV}1

fsck.ext3 -y ${DEV}1

mount ${DEV}1 /media/rootfs || exit
df

fi

wget $ROOTFS -O - | (cd /media/rootfs && tar xvjf - )
ls -l /media/rootfs

sync
if [ "$DEV" ]
then
df
umount ${DEV}1
rmdir /media/rootfs
fi
